<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MXNVD4PJ');
    </script>
    <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        var player;
        var youTubePlaylistId;
        function onYouTubeIframeAPIReady() {
            // console.log('YouTube Iframe API is ready.');
        }
    </script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>URL Parser</title>
    <meta name="description" content="Form to insert and analyze URLs with Domain Info.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MXNVD4PJ"
        height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <div class="container">
        <h1>URL Parser</h1>
        <form id="urlForm">
            <div class="form-group">
                <label for="urlInput">Enter URL:</label>
                <input type="text" class="form-control" id="urlInput"
                       placeholder="https://example.com/path?param=value#fragment">
            </div>
            <div id="button-container">
                <button type="button" class="btn btn-primary" id="parseButton" disabled>Parse</button>
                <p>&nbsp;</p> 
                <button type="button" class="btn btn-primary" id="decodeButton" disabled>Decode</button>
            </div>
        </form>
        <div id="output-container" class="mt-4">
            <h2>Analysis Result:</h2>
            <div class="table-responsive">
                <table id="parsedResult" class="url-table">
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <hr>
    <div id="youtube-embed-container"></div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const regexp = {
            UrlParts: /^((?:\w+:\/\/)?[^\/.:]+(?:\.[^\/.:?#]+)+)((?:\/?(?:[^\/?#]+)?)*)?(\?[^?]+?)?(#[^#]+?)?$/,
            Query: /([^?#&=]+)(?:=([^?#&=]+))?/,
            Fragment: /([^?#&=]+)(?:=([^#&=]+))?/,
            YouTubeVideo: /(https?:\/\/)?(www\.)?(m\.)?youtu(\.be|be\.com)\/(?:watch\?v=|embed\/)([0-9A-Za-z_-]{11})([\?&]\S*)?/i,
            YouTubePlaylist: /(https?:\/\/)?(www\.)?(m\.)?youtu(\.be|be\.com)\/.*?list=([0-9A-Za-z_-]+)/i
        };

        const parseKeyOptionalValue = (captureGroup, keyOptionalValue, re) => {
            if (captureGroup)
                while (re.test(captureGroup)) {
                    const groups = re.exec(captureGroup);
                    if (groups) {
                        if (groups[2]) {
                            keyOptionalValue.list.push(`${groups[1]}=${groups[2]||''}`);
                            keyOptionalValue.obj[groups[1]] = groups[2];
                        } else {
                            keyOptionalValue.list.push(groups[1]);
                            keyOptionalValue.obj[groups[1]] = '';
                        }
                        captureGroup = captureGroup.substring(groups[0].length+1);
                    }
                }
        }

        const parseUrl = (url) => {
            url = url.replaceAll('\\', '');
            const match = url.match(regexp.UrlParts);
            if (!match) {
                return undefined;
            }
            const domain = match[1] || '';
            const path = match[2] || '/';
            const queryString = match[3] || '';
            const hashString = match[4] || '';
            let parameters = { str: queryString, list: [], obj: {} }
            let fragment = { str: hashString, list: [], obj: {} }
            parseKeyOptionalValue(queryString, parameters, regexp.Query);
            parseKeyOptionalValue(hashString, fragment, regexp.Fragment);
            return {
                parts: {
                    domain: domain,
                    path: path,
                    parameters: parameters,
                    fragment: fragment
                },
                fullUrl: function () {
                    return domain + path + queryString + hashString;
                }
            };
        };

        document.addEventListener('DOMContentLoaded', function () {
            const parseButton = document.getElementById('parseButton');
            const urlInput = document.getElementById('urlInput');
            const parsedResultTableBody = document.querySelector('#parsedResult tbody');
            const decodeButton = document.getElementById('decodeButton');
            const youtubeEmbedContainer = document.getElementById('youtube-embed-container');
    
            const validateUrlInput = () => {
                const url = urlInput.value.replaceAll('\\', '');
                const parsed = parseUrl(url);
                if (parsed && parsed.parts.domain) {
                    urlInput.classList.remove('invalid');
                    urlInput.classList.add('valid');
                    parseButton.disabled = false;
                    decodeButton.disabled = false;
                } else {
                    urlInput.classList.remove('valid');
                    urlInput.classList.add('invalid');
                    parseButton.disabled = true;
                    decodeButton.disabled = true;
                }
            };
    
            urlInput.addEventListener('input', validateUrlInput);
    
            const handleParse = (decode) => {
                const url = urlInput.value.replaceAll('\\', '');
    
                if (url.startsWith('youtu.be')) {
                    window.location.href = url;
                    return;
                }
    
                const r = parseUrl(url);
                parsedResultTableBody.innerHTML = '';
                document.getElementById('output-container').querySelectorAll('#youtube-embed-container, .youtube-message-container').forEach(el => el.remove());
                document.body.classList.remove('youtube-background');
    
                if (!r) {
                    const row = parsedResultTableBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 2;
                    cell.textContent = "Invalid URL.";
                    return;
                }
    
                let isOdd = true;
    
                const addTableRow = (label, value, isOdd, isSubtable = false, isDomainRow = false, domain = '') => {
                    const row = parsedResultTableBody.insertRow();
                    const bgColor = isOdd ? (isSubtable ? '#2a2a2a' : '#222') : (isSubtable ? '#333' : '#282828');
                    row.style.backgroundColor = bgColor;
                    const labelCell = row.insertCell();
                    const valueCell = row.insertCell();
                    labelCell.textContent = label;
                    valueCell.innerHTML = value || '-';
                    labelCell.style.fontWeight = 'bold';
                    labelCell.style.paddingRight = '15px';
                    valueCell.style.color = '#ccc';
                    valueCell.style.backgroundColor = isOdd ? (isSubtable ? '' : '#333') : (isSubtable ? '' : '#3a3a3a');
                    if (isDomainRow && domain) {
                        const faviconUrl = `https://www.google.com/s2/favicons?domain=${domain}`;
                        const faviconImg = document.createElement('img');
                        faviconImg.src = faviconUrl;
                        faviconImg.width = 18;
                        faviconImg.height = 18;
                        faviconImg.style.marginRight = '8px';
                        faviconImg.style.verticalAlign = 'middle';
    
                        const domainLink = document.createElement('a');
                        domainLink.href = domain;
                        domainLink.className = 'url-link';
                        domainLink.textContent = domain;
    
                        valueCell.innerHTML = '';
    
                        faviconImg.onload = function() {
                            valueCell.appendChild(faviconImg);
                            valueCell.appendChild(domainLink);
                        };
                        faviconImg.onerror = function() {
                            valueCell.appendChild(domainLink);
                        };
                        valueCell.appendChild(domainLink);
                    }
                };
                let domain = r.parts.domain;
                let fullUrl = r.fullUrl();
                let path = r.parts.path;
                addTableRow("Domain", domain, isOdd, false, true, domain);
                isOdd = !isOdd;
                addTableRow("Path", path, isOdd);
                isOdd = !isOdd;
    
                if (r.parts.parameters.list.length > 0) {
                    addTableRow("Parameters", decode?decodeURIComponent(r.parts.parameters.str):r.parts.parameters.str, isOdd);
                    isOdd = !isOdd;
                    let paramsSubTable = '<table class="sub-table">';
                    let index = 0;
                    let maxKeyWidth = 0;
                    for (const key in r.parts.parameters.obj) {
                        const value = r.parts.parameters.obj[key] || '';
                        const decodedKey = decode ? decodeURIComponent(key) : key;
                        const decodedValue = decode ? decodeURIComponent(value) : value;
                        const keyHTML = `<span class="param-key-sub">${decodedKey}</span>`;
                        const tempDiv = document.createElement('div');
                        tempDiv.style.position = 'absolute';
                        tempDiv.style.visibility = 'hidden';
                        tempDiv.style.whiteSpace = 'nowrap';
                        tempDiv.innerHTML = keyHTML;
                        document.body.appendChild(tempDiv);
                        maxKeyWidth = Math.max(maxKeyWidth, tempDiv.offsetWidth);
                        document.body.removeChild(tempDiv);
                        paramsSubTable += `<tr style="background-color: ${index % 2 === 0 ? '#2a2a2a' : '#333'}"><td class="param-key-cell" style="width: ${maxKeyWidth}px">${keyHTML}</td><td class="param-value-cell">${decodedValue}</td></tr>`;
                        index++;
                    }
                    paramsSubTable += '</table>';
                    addTableRow("Detailed Parameters", paramsSubTable, isOdd, true);
                    isOdd = !isOdd;
                }
    
                if (r.parts.fragment.list.length > 0) {
                    addTableRow("Fragment", decode?decodeURIComponent(r.parts.fragment.str):r.parts.fragment.str, isOdd);
                    isOdd = !isOdd;
                    let fragmentSubTable = '<table class="sub-table">';
                    let index = 0;
                    let maxKeyWidth = 0;
                    for (const key in r.parts.fragment.obj) {
                        const value = r.parts.fragment.obj[key] || '';
                        const decodedKey = decode ? decodeURIComponent(key) : key;
                        const decodedValue = decode ? decodeURIComponent(value) : value;
                        const keyHTML = `<span class="param-key-sub">${decodedKey}</span>`;
                        const tempDiv = document.createElement('div');
                        tempDiv.style.position = 'absolute';
                        tempDiv.style.visibility = 'hidden';
                        tempDiv.style.whiteSpace = 'nowrap';
                        tempDiv.innerHTML = keyHTML;
                        document.body.appendChild(tempDiv);
                        maxKeyWidth = Math.max(maxKeyWidth, tempDiv.offsetWidth);
                        document.body.removeChild(tempDiv);
    
                        fragmentSubTable += `<tr style="background-color: ${index % 2 === 0 ? '#2a2a2a' : '#333'}"><td class="param-key-cell" style="width: ${maxKeyWidth}px">${keyHTML}</td><td class="param-value-cell">${decodedValue}</td></tr>`;
                        index++;
                    }
                    fragmentSubTable += '</table>';
                    addTableRow("Detailed Fragment", fragmentSubTable, isOdd, true);
                    isOdd = !isOdd;
                }
    
                addTableRow("Full URL", `<a href="${fullUrl}" class="url-link">${decode?decodeURIComponent(fullUrl):fullUrl}</a>`, isOdd);
    
                if (regexp.YouTubePlaylist.test(url)) {
                    document.body.classList.add('youtube-background');
                    const match = url.match(regexp.YouTubePlaylist);
                    const playlistId = match && match[5];
                    if (playlistId) {
                        youtubeEmbedContainer.innerHTML = '';
                        youTubePlaylistId = playlistId;
                        player = new YT.Player('youtube-embed-container', {
                            height: '270',
                            width: '480',
                            playerVars: {
                                'playsinline': 1,
                                'autoplay': 1,
                                'mute': 1
                            },
                            events: {
                                'onReady': onPlayerReadyYouTube,
                                'onStateChange': onPlayerStateChangeYouTube
                            }
                        })
                    } else {
                        const messageContainer = document.createElement('div');
                        messageContainer.classList.add('youtube-message-container');
                        messageContainer.style.marginTop = '20px';
                        messageContainer.style.color = '#ffaa00';
                        messageContainer.textContent = "Não foi possível extrair o ID da playlist.";
                        document.getElementById('output-container').appendChild(messageContainer);
                    } 
                } else if (regexp.YouTubeVideo.test(url)) {
                    document.body.classList.add('youtube-background');
                    const match = url.match(regexp.YouTubeVideo);
                    const videoId = match && match[5];
                    if (videoId) {
                        youtubeEmbedContainer.innerHTML = '';
                        let videoStart = '';
                        if (r.parts.parameters.obj.hasOwnProperty('t')
                            && /\d+/.test(r.parts.parameters.obj.t)) {
                            videoStart = r.parts.parameters.obj.t;
                        } else if (r.parts.parameters.obj.hasOwnProperty('start')
                            && /\d+/.test(r.parts.parameters.obj.start))
                            videoStart = r.parts.parameters.obj.start;
                        player = new YT.Player('youtube-embed-container', {
                            height: '270',
                            width: '480',
                            videoId: videoId,
                            playerVars: {
                                'playsinline': 1,
                                'autoplay': 1,
                                'mute': 1,
                                'start': parseInt(videoStart)
                            },
                            events: {
                                'onReady': onPlayerReadyYouTube,
                                'onStateChange': onPlayerStateChangeYouTube
                            }
                        });
                    } else {
                        const messageContainer = document.createElement('div');
                        messageContainer.classList.add('youtube-message-container');
                        messageContainer.style.marginTop = '20px';
                        messageContainer.style.color = '#ffaa00';
                        messageContainer.textContent = "Não foi possível extrair o ID do vídeo.";
                        document.getElementById('output-container').appendChild(messageContainer);
                    }
                } else {
                    youtubeEmbedContainer.innerHTML = '';
                    document.body.classList.remove('youtube-background');
                }
            };
    
            function onPlayerReadyYouTube(event) {
                if (youTubePlaylistId) {
                    event.target.loadPlaylist({
                        list: youTubePlaylistId,
                        listType: 'playlist',
                        index: 0,
                        startSeconds: 0
                    })
                    event.target.playVideo();
                    youTubePlaylistId = '';
                }
            }
    
            function onPlayerStateChangeYouTube(event) {
                // console.log('Player state changed:', event.data);
            }
    
            parseButton.addEventListener('click', () => handleParse(false));
            decodeButton.addEventListener('click', () => handleParse(true));
    
            urlInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (!parseButton.disabled) {
                        handleParse(false);
                    }
                }
            });
        });
        console.log(" _   _______ _       ______                                      \n| | | | ___ \\ |     | ___ \\                                       \n| | | | |_/ / |     | |_/ /_ _ _ __ ___ ___ _ __ \n| | | |  __/| |     |  __/ _` | '__/ __|/ _ \\ '__|\n| |_| | |\\ \\| |____ | | | (_| | |  \\__ \\  __/ |   \n \\___/\\_| \\_/_____/ \\_|  \\__,_|_|  |___/\\___|_|   \n\nhttps://github.com/tomasfn87/url-parser\n\n");
    </script>
</html>
